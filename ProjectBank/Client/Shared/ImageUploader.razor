@using System.Net.Http.Headers
@inject HttpClient Http
@inject NavigationManager NavigationManager

<div class="form-group input-group">
    @*<RadzenUpload Multiple="true" id="Image" Accept="image/*" OnChange="@OnFileSelection" Url="upload/multiple" Style="margin-bottom: 15px;">Image</RadzenUpload>
    <RadzenButton Text="Clear" Click="ClearImage" Style="margin-bottom: 15px;" />*@
    <InputFile id="Image" OnChange="@OnFileSelection" accept=".png, .jpeg, .gif, .jpg" class="form-control"/>
</div>
<div class="form-group">
        @if (!string.IsNullOrWhiteSpace(imageUrl))
        {
            <div style="display: flex; justify-content: center; align-content: center; padding: 1em"><img src="@imageUrl" alt="Project Image" class="img-thumbnail"></div>
            <button type="button" @onclick="UploadImage" class="btn btn-secondary" style="background-color:darkgreen; opacity: 70">Upload</button>
            <button type="button" @onclick="ClearImage" class="btn btn-secondary" >Clear</button>
        }@if (sizeExceeded)
         {
             <div style="display: flex; justify-content: center; align-content: center; padding: 1em; color: red">Maximum file size of 1.24 mb exceded.</div>
         }
</div>
@code {

    [Parameter]
    public int Id { get; set; }

    [Parameter]
    public bool isProject { get; set; }

    private ProjectDetailsDto toBeUpdated;

    private AccountDetailsDto toBeUpdatedAccount;

    private ProjectUpdateDto? project;

    private AccountUpdateDto? account;

    private string imageName = Guid.NewGuid().ToString();

    private string imageUrl = string.Empty;

    private IBrowserFile? imageFile;
    private bool sizeExceeded;

    protected override async Task OnInitializedAsync()
    {
        if (isProject)//if project
        {
            toBeUpdated = await Http.GetFromJsonAsync<ProjectDetailsDto>($"api/Project/{Id}");
            if (toBeUpdated != null)
            {
                project = new ProjectUpdateDto()
                {
                    Id = toBeUpdated.Id, Degree = toBeUpdated.Degree, Title = toBeUpdated.Title,
                    Description = toBeUpdated.Description, Ects = toBeUpdated.Ects, Keywords = toBeUpdated.Keywords, AuthorName = toBeUpdated.AuthorName,
                    AuthorToken = toBeUpdated.AuthorToken, FileUrl = toBeUpdated.FileUrl, ImageUrl = toBeUpdated.ImageUrl, LastUpdated = DateTime.UtcNow
                };
            }
        }
        else //if account
        {
            toBeUpdatedAccount = await Http.GetFromJsonAsync<AccountDetailsDto>($"api/Account/getBy{Id}");
            if (toBeUpdatedAccount != null)
            {
                account = new AccountUpdateDto()
                {
                    Id = toBeUpdatedAccount.Id, PictureUrl = toBeUpdatedAccount.PictureUrl, Name = toBeUpdatedAccount.Name,
                    SavedProjects = toBeUpdatedAccount.SavedProjects, AzureAAdToken = toBeUpdatedAccount.AzureAdToken
                };
            }
        }
        
    }

    private async Task UploadImage()
    {
        if (imageFile != null)
        {
            var bytes = new byte[imageFile.Size];
            await imageFile.OpenReadStream(1024000).ReadAsync(bytes);
            var byteContent = new ByteArrayContent(bytes);
            byteContent.Headers.ContentType = new MediaTypeHeaderValue(imageFile.ContentType);
            var content = new MultipartFormDataContent();
            content.Add(byteContent, "file", imageFile.Name);
            var response = await Http.PostAsync($"api/Image/{imageName}", content);

            if (response.IsSuccessStatusCode)
            {
                if (project != null)
                {
                    {
                        project.ImageUrl = response.Headers.Location?.ToString();
                        var updated = await Http.PutAsJsonAsync($"api/Project/{project.Id}", project);
                        Console.WriteLine(updated.StatusCode);
                    }
                }
                else if (account != null)
                {
                    {
                        account.PictureUrl = response.Headers.Location?.ToString();
                        var updated = await Http.PutAsJsonAsync($"api/Account/{account.Id}", account);
                        Console.WriteLine(updated.StatusCode);
                    }
                }
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
        }
    }
    private void ClearImage()
    {
        imageUrl = string.Empty;
        imageFile = null;
        StateHasChanged();
    }

    private void Cancel()
    {
        var uri = $"{NavigationManager.BaseUri}";

        NavigationManager.NavigateTo(uri);
        
    }

    private async Task OnFileSelection(InputFileChangeEventArgs e)
    {
        sizeExceeded = false;
        imageFile = e.GetMultipleFiles().FirstOrDefault();

        if (imageFile != null)
        {
            try
            {
                var bytes = new byte[imageFile.Size];
                await imageFile.OpenReadStream(1024000).ReadAsync(bytes);
                var contentType = imageFile.ContentType;
                imageUrl = $"data:{contentType};base64,{Convert.ToBase64String(bytes)}";
            }
            catch (IOException exception)
            {
                sizeExceeded = true;
                Console.WriteLine(exception);
            }
            
        }
    }
} 